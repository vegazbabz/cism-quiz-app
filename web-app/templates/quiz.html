<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CISM Practice Quiz</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-primary {
            background-color: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background-color: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn-secondary {
            background-color: #48bb78;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn-danger {
            background-color: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background-color: #e53e3e;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .stats-bar {
            background: rgba(255,255,255,0.95);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.12);
            position: sticky;
            top: 0;
            z-index: 200;
            backdrop-filter: blur(6px);
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .quiz-container {
            display: none;
        }

        .quiz-container.active {
            display: block;
        }

        .pill {
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            border-radius: 6px;
            background: #f8fafc;
            font-size: 0.95em;
            color: #334155;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .pill button {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-weight: 600;
        }

        .question-card {
            background: white;
            padding: 30px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .collapse-btn {
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            color: #334155;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            font-weight: 600;
        }

        .collapse-btn:hover {
            background: #eef2ff;
            color: #4338ca;
        }

        .question-body.collapsed {
            display: none;
        }

        .question-card:hover {
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .chapter-card {
            background: #f7f9fc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px 16px 8px 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 6px rgba(0,0,0,0.08);
        }

        .chapter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .chapter-body {
            margin-top: 10px;
        }

        .chapter-body.collapsed {
            display: none;
        }

        .chapter-note {
            font-size: 0.9em;
            color: #475569;
            margin-top: 6px;
        }

        .question-number {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .question-number.answered-correct {
            color: #48bb78;
        }

        .question-number.answered-incorrect {
            color: #f56565;
        }

        .question-text {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .choices {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .choice {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f9fafb;
        }

        .choice:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .choice input[type="radio"] {
            margin-right: 12px;
            margin-top: 2px;
            cursor: pointer;
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }

        .choice label {
            cursor: pointer;
            flex: 1;
            display: flex;
            align-items: center;
        }

        .choice.correct {
            border-color: #48bb78;
            background: #f0fdf4;
        }

        .choice.incorrect {
            border-color: #f56565;
            background: #fef2f2;
        }

        .choice.selected {
            border-color: #667eea;
            background: #eef2ff;
        }

        .feedback {
            margin-top: 20px;
            padding: 20px;
            border-radius: 6px;
            display: none;
        }

        .feedback.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feedback.correct {
            background: #f0fdf4;
            border-left: 4px solid #48bb78;
            color: #166534;
        }

        .feedback.incorrect {
            background: #fef2f2;
            border-left: 4px solid #f56565;
            color: #7f1d1d;
        }

        .feedback-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .feedback-answer {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.5);
            border-radius: 4px;
            font-size: 0.95em;
        }

        .feedback-explanation {
            margin-top: 12px;
            padding: 12px;
            background: rgba(255,255,255,0.5);
            border-radius: 4px;
            line-height: 1.6;
            font-style: italic;
        }

        .welcome-screen {
            background: white;
            padding: 60px 40px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 600px;
            margin: 0 auto;
        }

        .welcome-screen h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .welcome-screen p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.8;
            font-size: 1.05em;
        }

        .welcome-screen .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .results-screen {
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 600px;
            margin: 0 auto;
        }

        .results-screen h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .score-display {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin: 30px 0;
        }

        .rating {
            font-size: 1.3em;
            margin: 20px 0;
        }

        .rating.excellent { color: #48bb78; }
        .rating.very-good { color: #38b2ac; }
        .rating.good { color: #ed8936; }
        .rating.fair { color: #ed8936; }
        .rating.poor { color: #f56565; }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            margin-top: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
        }

        .loading-spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .questions-count {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        .quick-nav {
            position: fixed;
            right: 24px;
            bottom: 24px;
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 400;
        }

        /* Chapter side navigation */
        .chapter-nav {
            position: fixed;
            right: 24px;
            top: 140px;
            width: 220px;
            background: rgba(255,255,255,0.96);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.18);
            padding: 14px 14px 10px 14px;
            z-index: 380;
            display: none;
            border: 1px solid #e2e8f0;
        }

        .chapter-nav h3 {
            margin: 0 0 8px 0;
            font-size: 1em;
            color: #334155;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chapter-nav-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .chapter-nav button {
            width: 100%;
            text-align: left;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 8px;
            cursor: pointer;
            color: #1f2937;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .chapter-nav button:hover {
            background: #eef2ff;
            border-color: #c7d2fe;
            color: #4338ca;
        }

        @media (max-width: 1100px) {
            .chapter-nav {
                display: none !important;
            }
        }

        .quick-btn {
            padding: 10px 14px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.95);
            color: #1f2937;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 14px rgba(0,0,0,0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .quick-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 18px rgba(0,0,0,0.22);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .question-card {
                padding: 20px;
            }

            .choice {
                padding: 12px;
            }

            .controls {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .stats-bar {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: #667eea;
            font-size: 1.5em;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2em;
            color: #94a3b8;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #f1f5f9;
            color: #475569;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .stats-table th,
        .stats-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .stats-table th {
            background: #f8fafc;
            color: #475569;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stats-table tr:hover {
            background: #f8fafc;
        }

        .stats-table td {
            color: #334155;
        }

        .stats-percentage {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .stats-percentage.excellent { background: #d1fae5; color: #065f46; }
        .stats-percentage.good { background: #dbeafe; color: #1e40af; }
        .stats-percentage.fair { background: #fed7aa; color: #92400e; }
        .stats-percentage.poor { background: #fecaca; color: #991b1b; }

        .no-stats {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }

        .no-stats-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö CISM Practice Quiz</h1>
            <p>Learn by answering questions with instant feedback</p>
        </div>

        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="welcome-screen">
            <h2>Welcome to CISM Quiz</h2>
            <p>Test your knowledge with interactive multiple-choice questions. Get instant feedback and detailed explanations for each answer.</p>
            <div class="button-group">
                <button class="btn btn-primary" title="Take quiz with questions in their original order. Answer all questions to see your score." onclick="startQuiz()">
                    ‚ñ∂Ô∏è Start Quiz
                </button>
                <button class="btn btn-secondary" title="Same as Start Quiz but questions appear in random order to prevent memorization." onclick="startShuffledQuiz()">
                    üîÄ Shuffle Questions
                </button>
                <button class="btn btn-secondary" title="Review all questions with answers immediately visible. Perfect for learning the material." onclick="practiceMode()">
                    üìñ Practice Mode
                </button>
                <button class="btn btn-secondary" title="Pick an even number of questions (10, 20, 30, ...) and take a shorter quiz." onclick="startCustomCountQuiz()">
                    üéØ Custom Length
                </button>
                <button class="btn btn-secondary" title="View your past quiz results and track your progress over time." onclick="showStatistics()" style="background: #6c757d;">
                    üìä View Statistics
                </button>
            </div>
            <div style="margin-top: 40px; font-size: 0.95em; color: #666; background: #f0f4ff; padding: 20px; border-radius: 8px;">
                <strong>üí° Button Guide:</strong>
                <ul style="margin-top: 10px; margin-left: 20px;">
                    <li><strong>‚ñ∂Ô∏è Start Quiz:</strong> Take all questions in order. Select your answer and see instant feedback. Your score is calculated when you finish.</li>
                    <li><strong>üîÄ Shuffle Questions:</strong> Same as Start Quiz but questions are randomized. Great for testing without memorizing order.</li>
                    <li><strong>üìñ Practice Mode:</strong> Review all questions with answers and explanations shown right away. Ideal for studying and learning. No scoring.</li>
                    <li><strong>üéØ Custom Length:</strong> Select an even number of questions (10, 20, 30, etc.) for a shorter randomized quiz. Perfect for quick practice sessions.</li>
                </ul>
            </div>
        </div>

        <!-- Quiz Container -->
        <div id="quizContainer" class="quiz-container">
            <div class="stats-bar">
                <div style="display:flex; gap:16px; align-items:center; flex-wrap:wrap;">
                    <div class="stat-item">
                        <div class="stat-label">Current Score</div>
                        <div class="stat-value"><span id="currentScore">0</span>/<span id="totalQuestions">0</span></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Percentage</div>
                        <div class="stat-value"><span id="percentage">0</span>%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Answered</div>
                        <div class="stat-value"><span id="answeredCount">0</span>/<span id="totalQuestionsCount">0</span></div>
                    </div>
                </div>
                <div class="pill">
                    <span id="timerLabel">‚è±Ô∏è 00:00</span>
                    <button type="button" onclick="toggleTimerVisibility()" id="timerToggle">Hide</button>
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-danger" onclick="endQuiz()">End Quiz</button>
                <button class="btn btn-primary" id="resetBtn" onclick="resetQuiz()">Reset All Answers</button>
            </div>

            <div class="questions-count" id="loadingIndicator">
                Loading all questions... This may take a moment with large question sets.
            </div>

            <div id="questionsContainer"></div>
        </div>

        <div id="quickNav" class="quick-nav" aria-label="Quick navigation">
            <button class="quick-btn" onclick="scrollToTop()">Top</button>
            <button class="quick-btn" id="gotoChapterBtn" onclick="scrollToNearestChapter()">Go to chapter</button>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="results-screen" style="display: none;">
            <h2>Quiz Complete!</h2>
            <div class="score-display"><span id="finalScore">0</span>/<span id="finalTotal">0</span></div>
            <div id="rating" class="rating"></div>
            <div id="resultsSummary"></div>
            <div style="margin-top: 30px;">
                <button class="btn btn-primary" onclick="location.reload()">Start Over</button>
            </div>
        </div>

        <!-- Statistics Modal -->
        <div id="statsModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üìä Quiz Statistics</h2>
                    <button class="modal-close" onclick="closeStatistics()">&times;</button>
                </div>
                <div class="modal-body" id="statsContent">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        Loading statistics...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chapter Navigation -->
        <div id="chapterNav" class="chapter-nav" aria-label="Chapter navigation">
            <h3>üìñ Chapters</h3>
            <div id="chapterNavList" class="chapter-nav-list"></div>
        </div>
    </div>

    <script>
        let allQuestions = [];
        let currentQuestions = [];
        let answers = {};
        let isQuizActive = false;
        let shuffled = false;
        let isPracticeMode = false;
        let chapterData = [];
        let timerInterval = null;
        let timerStart = null;
        let timerHidden = false;

        // Progress saving functions
        async function saveProgress() {
            if (!isQuizActive) return;
            const progressData = {
                timestamp: new Date().toISOString(),
                currentQuestions: currentQuestions,
                answers: answers,
                shuffled: shuffled,
                isPracticeMode: isPracticeMode,
                timerStart: timerStart,
                questionsCount: currentQuestions.length,
                answeredCount: Object.keys(answers).length
            };
            try {
                const response = await fetch('/api/progress', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(progressData)
                });
                if (!response.ok) console.warn('Failed to save progress to server');
            } catch (error) {
                console.warn('Could not save progress to server:', error);
            }
            // Always save to localStorage as backup
            localStorage.setItem('quizProgress', JSON.stringify(progressData));
        }

        async function loadProgress() {
            try {
                // Try loading from server first
                const response = await fetch('/api/progress');
                const data = await response.json();
                if (data.found && data.progress) {
                    return data.progress;
                }
            } catch (error) {
                console.warn('Could not load progress from server:', error);
            }
            // Fall back to localStorage
            const stored = localStorage.getItem('quizProgress');
            return stored ? JSON.parse(stored) : null;
        }

        async function clearProgress() {
            try {
                await fetch('/api/progress/clear', { method: 'DELETE' });
            } catch (error) {
                console.warn('Could not clear server progress:', error);
            }
            localStorage.removeItem('quizProgress');
        }

        function showResumePrompt(progress) {
            const answered = progress.answeredCount || Object.keys(progress.answers || {}).length;
            const total = progress.questionsCount || progress.currentQuestions.length;
            const timeElapsed = progress.timerStart ? Math.floor((Date.now() - new Date(progress.timerStart).getTime()) / 1000) : 0;
            const minutes = Math.floor(timeElapsed / 60);
            const secondsStr = String(timeElapsed % 60).padStart(2, '0');
            
            const resumeDiv = document.createElement('div');
            resumeDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 8px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 400px;
                text-align: center;
            `;
            resumeDiv.innerHTML = `
                <h2 style="margin-bottom: 15px; color: #333;">Quiz Progress Found</h2>
                <p style="margin-bottom: 10px; color: #666;">You have an incomplete quiz saved</p>
                <p style="margin-bottom: 20px; color: #999; font-size: 0.9em;">
                    <strong>${answered}/${total}</strong> questions answered<br>
                    Time spent: <strong>${minutes}m ${secondsStr}s</strong>
                </p>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="resumeBtn" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">Resume Quiz</button>
                    <button id="newBtn" style="padding: 10px 20px; background: #48bb78; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">Start New</button>
                </div>
            `;
            document.body.appendChild(resumeDiv);
            
            const backdrop = document.createElement('div');
            backdrop.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 9999;
            `;
            document.body.appendChild(backdrop);
            
            document.getElementById('resumeBtn').addEventListener('click', () => {
                resumeDiv.remove();
                backdrop.remove();
                resumeQuiz(progress);
            });
            
            document.getElementById('newBtn').addEventListener('click', async () => {
                resumeDiv.remove();
                backdrop.remove();
                await clearProgress();
                // Start fresh quiz without returning to welcome screen
                currentQuestions = allQuestions;
                shuffled = false;
                isPracticeMode = false;
                initializeQuiz();
            });
        }

        async function resumeQuiz(progress) {
            currentQuestions = progress.currentQuestions;
            answers = progress.answers || {};
            shuffled = progress.shuffled;
            isPracticeMode = progress.isPracticeMode;
            // Calculate elapsed time from original start, not from saved timestamp
            const savedStartMs = typeof progress.timerStart === 'string' 
                ? new Date(progress.timerStart).getTime() 
                : progress.timerStart;
            const elapsedSinceStart = Date.now() - savedStartMs;
            timerStart = Date.now() - elapsedSinceStart;
            
            initializeQuiz();
            console.log('‚úì Quiz progress resumed');
        }

        // Load questions on page load
        async function loadQuestions() {
            try {
                const response = await fetch('/api/questions');
                const data = await response.json();
                allQuestions = data.questions;
                console.log(`‚úì Loaded ${data.total} questions`);
                await loadChapters();
            } catch (error) {
                console.error('Error loading questions:', error);
                alert('Failed to load questions. Make sure cism_questions.json exists.');
            }
        }

        async function loadChapters() {
            try {
                const response = await fetch('/api/chapters', { cache: 'no-store' });
                const data = await response.json();
                chapterData = data.chapters || [];
                console.log('Chapters loaded:', chapterData.map(ch => ({ c: ch.chapter, items: (ch.overview || []).length })));
                renderChapters();
            } catch (error) {
                console.error('Error loading chapters:', error);
                chapterData = [];
            }
        }

        function renderChapters() {
            // Chapters now render inline with questions; nothing to do here.
            return;
        }

        function chapterForQuestion(questionNumber) {
            if (!chapterData.length) return null;
            let current = null;
            for (let i = 0; i < chapterData.length; i++) {
                const ch = chapterData[i];
                const nextStart = chapterData[i + 1]?.start_question || Infinity;
                if (questionNumber >= ch.start_question && questionNumber < nextStart) {
                    current = ch;
                    break;
                }
            }
            return current;
        }

        async function startQuiz() {
            if (allQuestions.length === 0) await loadQuestions();
            
            // Check for saved progress
            const savedProgress = await loadProgress();
            if (savedProgress && savedProgress.currentQuestions && savedProgress.currentQuestions.length > 0) {
                showResumePrompt(savedProgress);
                return;
            }
            
            currentQuestions = allQuestions;
            shuffled = false;
            isPracticeMode = false;
            initializeQuiz();
        }

        async function startShuffledQuiz() {
            if (allQuestions.length === 0) await loadQuestions();
            try {
                const response = await fetch('/api/questions/shuffled');
                const data = await response.json();
                currentQuestions = data.questions;
                shuffled = true;
                isPracticeMode = false;
                initializeQuiz();
            } catch (error) {
                console.error('Error loading shuffled questions:', error);
            }
        }

        async function startCustomCountQuiz() {
            if (allQuestions.length === 0) await loadQuestions();
            const total = allQuestions.length;
            const input = prompt(`Enter an even number of questions (max ${total}).`, '10');
            if (!input) return;
            const count = parseInt(input, 10);
            if (isNaN(count) || count <= 0 || count > total || count % 2 !== 0) {
                alert('Please enter a valid even number within range.');
                return;
            }
            const shuffledCopy = [...allQuestions].sort(() => Math.random() - 0.5);
            currentQuestions = shuffledCopy.slice(0, count);
            shuffled = true;
            isPracticeMode = false;
            initializeQuiz();
        }

        async function practiceMode() {
            if (allQuestions.length === 0) await loadQuestions();
            currentQuestions = allQuestions;
            shuffled = false;
            isPracticeMode = true;
            initializeQuiz();
        }

        function initializeQuiz() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('quizContainer').classList.add('active');
            document.getElementById('resultsScreen').style.display = 'none';
            const resetBtn = document.getElementById('resetBtn');
            if (resetBtn) resetBtn.style.display = isPracticeMode ? 'none' : 'inline-block';
            
            isQuizActive = true;
            // Only reset answers if we're not resuming (if answers is empty)
            if (Object.keys(answers).length === 0) {
                answers = {};
            }
            if (isPracticeMode && currentQuestions.length) {
                currentQuestions.forEach((q, idx) => {
                    const suffix = `${q.number}-${idx + 1}`;
                    const correct = (q.answer || '').trim().toUpperCase();
                    answers[suffix] = { answer: correct, questionNumber: q.number, ordinal: idx + 1 };
                });
            }
            stopTimer();
            // Only reset timerStart if we're not resuming (if timerStart is null)
            if (timerStart === null) {
                timerStart = Date.now();
            }
            startTimer();
            
            document.getElementById('totalQuestions').textContent = currentQuestions.length;
            document.getElementById('totalQuestionsCount').textContent = currentQuestions.length;
            
            renderQuestions();
            updateStats();
        }

        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            const loadingIndicator = document.getElementById('loadingIndicator');
            
            container.innerHTML = '';
            loadingIndicator.textContent = `Loading ${currentQuestions.length} questions...`;
            
            // Render all questions at once (for large sets, use document fragment for performance)
            const fragment = document.createDocumentFragment();
            let lastChapterRendered = null;
            
            currentQuestions.forEach((question, index) => {
                const ordinal = index + 1;
                const domSuffix = `${question.number}-${ordinal}`;
                if (!shuffled) {
                    const chapter = chapterForQuestion(ordinal);
                    if (chapter && chapter !== lastChapterRendered && ordinal === chapter.start_question) {
                        fragment.appendChild(createChapterElement(chapter));
                        lastChapterRendered = chapter;
                    }
                }

                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                questionCard.id = `question-${domSuffix}`;

                let choicesHtml = '<div class="choices">';
                const saved = answers[domSuffix];
                const savedAnswer = saved ? saved.answer : null;
                const correctAnswer = (question.answer || '').trim().toUpperCase();

                Object.entries(question.choices).forEach(([letter, text]) => {
                    const isChecked = isPracticeMode ? (letter === correctAnswer ? 'checked' : '') : (savedAnswer === letter ? 'checked' : '');
                    const selectedClass = isPracticeMode
                        ? (letter === correctAnswer ? 'correct' : '')
                        : (savedAnswer === letter ? 'selected' : '');
                    const disabledAttr = isPracticeMode ? 'disabled' : '';
                    choicesHtml += `
                        <div class="choice ${selectedClass}" onclick="${isPracticeMode ? '' : 'handleChoiceClick(this)'}">
                            <input type="radio" id="q${domSuffix}_${letter}" 
                                   name="question_${domSuffix}" 
                                   value="${letter}" 
                                   ${isChecked} ${disabledAttr}
                                onchange="${isPracticeMode ? '' : `selectAnswer(${question.number}, '${letter}', '${domSuffix}')`}">
                            <label for="q${domSuffix}_${letter}">
                                <strong>${letter}.</strong> ${text}
                            </label>
                        </div>
                    `;
                });
                choicesHtml += '</div>';

                const feedbackId = `feedback-${domSuffix}`;
                let feedbackHtml = `<div class="feedback ${isPracticeMode ? 'show correct' : ''}" id="${feedbackId}">`;
                if (isPracticeMode) {
                    const explanation = question.explanation || '';
                    const choiceText = question.choices && question.choices[correctAnswer] ? question.choices[correctAnswer] : '';
                    feedbackHtml += `
                        <div class="feedback-title">‚úì Correct Answer</div>
                        <div class="feedback-answer"><strong>${correctAnswer}.</strong> ${choiceText}</div>
                        ${explanation ? `<div class="feedback-explanation"><strong>üìñ Explanation:</strong><br>${explanation}</div>` : ''}
                    `;
                    feedbackHtml += `</div>`;
                } else {
                    feedbackHtml += `</div>`;
                }

                const isAnswered = answers[domSuffix];
                const isCorrect = isAnswered && isAnswered.answer === correctAnswer;
                const qNumberClass = isAnswered ? (isCorrect ? 'answered-correct' : 'answered-incorrect') : '';

                questionCard.innerHTML = `
                    <div class="question-header">
                        <div class="question-number ${qNumberClass}" id="qnum-${domSuffix}">Question ${question.number}</div>
                        <button class="collapse-btn" id="collapse-btn-${domSuffix}" onclick="toggleQuestion('${domSuffix}')">Collapse</button>
                    </div>
                    <div class="question-body" id="qbody-${domSuffix}">
                        <div class="question-text">${question.question}</div>
                        ${choicesHtml}
                        ${feedbackHtml}
                    </div>
                `;
                
                fragment.appendChild(questionCard);
            });
            
            container.appendChild(fragment);
            loadingIndicator.textContent = `‚úì All ${currentQuestions.length} questions loaded!`;
            
            // Show feedback for already-answered questions (resume case)
            Object.entries(answers).forEach(async ([suffix, answerData]) => {
                if (answerData && answerData.answer && !isPracticeMode) {
                    const feedbackDiv = document.getElementById(`feedback-${suffix}`);
                    // Check if feedback hasn't been loaded yet by looking for content
                    if (feedbackDiv && !feedbackDiv.querySelector('.feedback-title')) {
                        try {
                            const response = await fetch('/api/check-answer', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    question_number: answerData.questionNumber,
                                    answer: answerData.answer
                                })
                            });
                            
                            if (response.ok) {
                                const result = await response.json();
                                
                                let feedbackClass = result.correct ? 'correct' : 'incorrect';
                                let feedbackTitle = result.correct ? '‚úì Correct!' : '‚úó Incorrect';
                                
                                let feedbackContent = `
                                    <div class="feedback-title">${feedbackTitle}</div>
                                `;
                                
                                if (!result.correct && result.correct_answer) {
                                    feedbackContent += `
                                        <div class="feedback-answer">
                                            <strong>Correct Answer:</strong> ${result.correct_answer}. ${result.choice_text}
                                        </div>
                                    `;
                                }
                                
                                if (result.explanation) {
                                    feedbackContent += `
                                        <div class="feedback-explanation">
                                            <strong>üìñ Explanation:</strong><br>${result.explanation}
                                        </div>
                                    `;
                                }
                                
                                feedbackDiv.innerHTML = feedbackContent;
                                feedbackDiv.className = `feedback show ${feedbackClass}`;
                                
                                // Update choice styling for visual feedback
                                const questionCard = document.getElementById(`question-${suffix}`);
                                if (questionCard) {
                                    questionCard.querySelectorAll('.choice').forEach(choice => {
                                        const radio = choice.querySelector('input[type="radio"]');
                                        if (radio.value === result.correct_answer) {
                                            choice.classList.add('correct');
                                        } else if (radio.checked && radio.value !== result.correct_answer) {
                                            choice.classList.add('incorrect');
                                        }
                                    });
                                }
                            }
                        } catch (error) {
                            console.warn(`Could not load feedback for question ${suffix}:`, error);
                        }
                    }
                }
            });
            
            // Scroll to top
            window.scrollTo(0, 0);
            renderChapterNav();
            updateQuickNavVisibility();
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function scrollToNearestChapter() {
            const chapters = Array.from(document.querySelectorAll('.chapter-card'));
            if (!chapters.length) {
                scrollToTop();
                return;
            }
            const currentTop = window.scrollY + 10;
            let target = chapters[0];
            for (const ch of chapters) {
                if (ch.offsetTop <= currentTop) {
                    target = ch;
                } else {
                    break;
                }
            }
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function scrollToChapter(chapterNumber) {
            const target = document.getElementById(`chapter-card-${chapterNumber}`);
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function updateQuickNavVisibility() {
            const nav = document.getElementById('quickNav');
            if (!nav) return;
            const active = document.getElementById('quizContainer').classList.contains('active');
            nav.style.display = active && window.scrollY > 200 ? 'flex' : 'none';
            const chapterBtn = document.getElementById('gotoChapterBtn');
            if (chapterBtn) {
                chapterBtn.style.display = shuffled ? 'none' : 'block';
            }

            const chapterNav = document.getElementById('chapterNav');
            if (chapterNav) {
                // Hide side nav when quiz not active or in shuffled/custom modes
                const shouldShow = active && !shuffled;
                chapterNav.style.display = shouldShow ? 'block' : 'none';
            }
        }

        function handleChoiceClick(element) {
            // Remove selected class from all choices in this group
            const questionCard = element.closest('.question-card');
            questionCard.querySelectorAll('.choice').forEach(choice => {
                choice.classList.remove('selected');
            });
            
            // Add selected class to clicked choice
            element.classList.add('selected');
            
            // Trigger radio button change
            const radio = element.querySelector('input[type="radio"]');
            if (radio && !radio.checked) {
                radio.click();
            }
        }

        function toggleQuestion(questionNumber) {
            const body = document.getElementById(`qbody-${questionNumber}`);
            const btn = document.getElementById(`collapse-btn-${questionNumber}`);
            if (!body || !btn) return;
            const isCollapsed = body.classList.toggle('collapsed');
            btn.textContent = isCollapsed ? 'Expand' : 'Collapse';
        }

        function createChapterElement(chapter) {
            const container = document.createElement('div');
            container.className = 'chapter-card';
            container.id = `chapter-card-${chapter.chapter}`;

            const bodyId = `chapter-body-${chapter.chapter}`;
            const btnId = `chapter-btn-${chapter.chapter}`;

            // Build header
            const header = document.createElement('div');
            header.className = 'chapter-header';
            header.setAttribute('onclick', `toggleChapter(${chapter.chapter})`);

            const headerText = document.createElement('div');
            const titleDiv = document.createElement('div');
            titleDiv.style.fontWeight = '700';
            titleDiv.style.color = '#1f2937';
            titleDiv.textContent = `Chapter ${chapter.chapter}: ${chapter.title}`;
            const noteDiv = document.createElement('div');
            noteDiv.className = 'chapter-note';
            noteDiv.textContent = 'Overview (click to collapse) ‚Ä¢ Questions for this chapter start here.';
            headerText.appendChild(titleDiv);
            headerText.appendChild(noteDiv);

            const collapseBtn = document.createElement('button');
            collapseBtn.className = 'collapse-btn';
            collapseBtn.id = btnId;
            collapseBtn.textContent = 'Collapse';

            header.appendChild(headerText);
            header.appendChild(collapseBtn);

            const body = document.createElement('div');
            body.className = 'chapter-body';
            body.id = bodyId;

            if (Array.isArray(chapter.overview)) {
                let currentList = null;

                chapter.overview.forEach(item => {
                    const raw = typeof item === 'string' ? item : (item?.toString?.() ?? '');
                    const isBullet = raw.startsWith('- ');

                    if (isBullet) {
                        // This is a bullet point
                        if (!currentList) {
                            currentList = document.createElement('ul');
                            currentList.style.marginLeft = '18px';
                            currentList.style.marginTop = '8px';
                            currentList.style.lineHeight = '1.5';
                            body.appendChild(currentList);
                        }
                        const li = document.createElement('li');
                        li.textContent = raw.substring(2); // Remove "- " prefix
                        currentList.appendChild(li);
                    } else {
                        // This is regular text (paragraph, task, etc.)
                        if (currentList) {
                            currentList = null; // Close the list before adding text
                        }
                        const div = document.createElement('div');
                        div.style.marginTop = '8px';
                        div.style.lineHeight = '1.5';
                        div.style.whiteSpace = 'pre-line';
                        div.textContent = raw; // Preserve exact text and line breaks
                        body.appendChild(div);
                    }
                });
            }

            container.appendChild(header);
            container.appendChild(body);

            return container;
        }

        function renderChapterNav() {
            const nav = document.getElementById('chapterNav');
            const list = document.getElementById('chapterNavList');
            if (!nav || !list) return;

            if (shuffled || !Array.isArray(chapterData) || !chapterData.length) {
                nav.style.display = 'none';
                return;
            }

            list.innerHTML = '';
            chapterData.forEach(ch => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = `Chapter ${ch.chapter}: ${ch.title}`;
                btn.onclick = () => scrollToChapter(ch.chapter);
                list.appendChild(btn);
            });

            nav.style.display = 'block';
        }

        function toggleChapter(chapterNumber) {
            const body = document.getElementById(`chapter-body-${chapterNumber}`);
            const btn = document.getElementById(`chapter-btn-${chapterNumber}`);
            if (!body || !btn) return;
            const isCollapsed = body.classList.toggle('collapsed');
            btn.textContent = isCollapsed ? 'Expand' : 'Collapse';
        }

        async function selectAnswer(questionNumber, answer, domSuffix = null) {
            const suffix = domSuffix || String(questionNumber);
            let ordinal = null;
            if (domSuffix) {
                const parts = String(domSuffix).split('-');
                const tail = parseInt(parts[parts.length - 1], 10);
                ordinal = isNaN(tail) ? null : tail;
            }
            answers[suffix] = { answer: answer.toUpperCase(), questionNumber, ordinal };
            updateStats();
            saveProgress(); // Save progress after each answer
            
            // Find the question
            let question = null;
            if (ordinal && currentQuestions[ordinal - 1]) {
                question = currentQuestions[ordinal - 1];
            } else {
                question = currentQuestions.find(q => q.number === questionNumber);
            }
            if (!question) return;
            
            // Show feedback immediately
            const feedbackDiv = document.getElementById(`feedback-${suffix}`);
            feedbackDiv.classList.remove('show', 'correct', 'incorrect');
            
            try {
                const response = await fetch('/api/check-answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question_id: questionNumber,
                        answer: answer
                    })
                });
                
                const result = await response.json();
                
                // Handle error responses
                if (response.status !== 200 || !result.correct_answer) {
                    feedbackDiv.innerHTML = `
                        <div class="feedback-title">‚ö†Ô∏è Answer Information Incomplete</div>
                        <div class="feedback-explanation">
                            This question doesn't have answer data available yet.
                        </div>
                    `;
                    feedbackDiv.className = `feedback show`;
                    return;
                }
                
                // Update choice styling
                const questionCard = document.getElementById(`question-${suffix}`);
                questionCard.querySelectorAll('.choice').forEach(choice => {
                    choice.classList.remove('correct', 'incorrect');
                    
                    const radio = choice.querySelector('input[type="radio"]');
                    if (radio.value === result.correct_answer) {
                        choice.classList.add('correct');
                    } else if (radio.checked && radio.value !== result.correct_answer) {
                        choice.classList.add('incorrect');
                    }
                });
                
                // Show feedback
                let feedbackClass = result.correct ? 'correct' : 'incorrect';
                let feedbackTitle = result.correct ? '‚úì Correct!' : '‚úó Incorrect';
                
                let feedbackContent = `
                    <div class="feedback-title">${feedbackTitle}</div>
                `;
                
                if (!result.correct && result.correct_answer) {
                    feedbackContent += `
                        <div class="feedback-answer">
                            <strong>Correct Answer:</strong> ${result.correct_answer}. ${result.choice_text}
                        </div>
                    `;
                }
                
                if (result.explanation) {
                    feedbackContent += `
                        <div class="feedback-explanation">
                            <strong>üìñ Explanation:</strong><br>${result.explanation}
                        </div>
                    `;
                }
                
                feedbackDiv.innerHTML = feedbackContent;
                feedbackDiv.className = `feedback show ${feedbackClass}`;
                
                // Update question number color
                const qNumEl = document.getElementById(`qnum-${suffix}`);
                if (qNumEl) {
                    qNumEl.classList.remove('answered-correct', 'answered-incorrect');
                    if (result.correct) {
                        qNumEl.classList.add('answered-correct');
                    } else {
                        qNumEl.classList.add('answered-incorrect');
                    }
                }

            } catch (error) {
                console.error('Error checking answer:', error);
                feedbackDiv.innerHTML = `
                    <div class="feedback-title">‚ùå Error</div>
                    <div class="feedback-explanation">
                        There was an error checking your answer. Please try again.
                    </div>
                `;
                feedbackDiv.className = `feedback show incorrect`;
            }
        }

        function updateStats() {
            const answered = Object.keys(answers).length;
            const total = currentQuestions.length;

            if (isPracticeMode) {
                document.getElementById('currentScore').textContent = '‚Äî';
                document.getElementById('answeredCount').textContent = '‚Äî';
                document.getElementById('percentage').textContent = '‚Äî';
                return;
            }

            let correct = 0;
            Object.values(answers).forEach(entry => {
                if (!entry) return;
                const { answer, questionNumber, ordinal } = entry;
                let question = null;
                if (ordinal && currentQuestions[ordinal - 1]) {
                    question = currentQuestions[ordinal - 1];
                } else {
                    question = currentQuestions.find(q => q.number === questionNumber);
                }
                if (question && question.answer === answer.toUpperCase()) {
                    correct++;
                }
            });
            
            document.getElementById('currentScore').textContent = correct;
            document.getElementById('answeredCount').textContent = answered;
            const percentage = total > 0 ? Math.round((correct / total) * 100) : 0;
            document.getElementById('percentage').textContent = percentage;
        }

        function startTimer() {
            const label = document.getElementById('timerLabel');
            if (!label) return;
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimerLabel, 1000);
            updateTimerLabel();
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updateTimerLabel() {
            if (!timerStart) return;
            const label = document.getElementById('timerLabel');
            if (!label) return;
            const elapsedMs = Date.now() - timerStart;
            const totalSeconds = Math.floor(elapsedMs / 1000);
            const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
            const seconds = String(totalSeconds % 60).padStart(2, '0');
            label.textContent = `‚è±Ô∏è ${minutes}:${seconds}`;
            if (timerHidden) {
                label.style.visibility = 'hidden';
            } else {
                label.style.visibility = 'visible';
            }
        }

        function toggleTimerVisibility() {
            timerHidden = !timerHidden;
            const toggleBtn = document.getElementById('timerToggle');
            if (toggleBtn) toggleBtn.textContent = timerHidden ? 'Show' : 'Hide';
            updateTimerLabel();
        }

        function resetQuiz() {
            if (confirm('Are you sure you want to reset all answers?')) {
                answers = {};
                renderQuestions();
                updateStats();
                saveProgress(); // Save the cleared progress
            }
        }

        async function endQuiz() {
            if (!confirm('Are you sure you want to end the quiz?')) {
                return;
            }

            if (isPracticeMode) {
                alert('Practice mode is for learning and does not produce a score. Returning to the start.');
                exitToWelcome();
                return;
            }
            
            const total = currentQuestions.length;
            let correct = 0;
            
            Object.values(answers).forEach(entry => {
                if (!entry) return;
                const { answer, questionNumber, ordinal } = entry;
                let question = null;
                if (ordinal && currentQuestions[ordinal - 1]) {
                    question = currentQuestions[ordinal - 1];
                } else {
                    question = currentQuestions.find(q => q.number === questionNumber);
                }
                if (question && question.answer === answer.toUpperCase()) {
                    correct++;
                }
            });
            
            // Save results
            await fetch('/api/save-result', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ score: correct, total: total })
            });
            
            // Clear progress after completing quiz
            await clearProgress();
            
            // Show results
            stopTimer();
            showResults(correct, total);
        }

        function exitToWelcome() {
            stopTimer();
            isQuizActive = false;
            clearProgress(); // Clear progress when exiting to welcome
            document.getElementById('quizContainer').classList.remove('active');
            document.getElementById('resultsScreen').style.display = 'none';
            document.getElementById('welcomeScreen').style.display = 'block';
            window.scrollTo(0, 0);
            updateQuickNavVisibility();
        }

        function showResults(score, total) {
            document.getElementById('quizContainer').classList.remove('active');
            document.getElementById('resultsScreen').style.display = 'block';
            updateQuickNavVisibility();
            
            document.getElementById('finalScore').textContent = score;
            document.getElementById('finalTotal').textContent = total;
            
            const percentage = (score / total * 100).toFixed(1);
            const ratingDiv = document.getElementById('rating');
            let rating = '';
            let ratingClass = '';
            
            if (percentage >= 90) {
                rating = 'üåü Excellent!';
                ratingClass = 'excellent';
            } else if (percentage >= 80) {
                rating = 'üëç Very Good!';
                ratingClass = 'very-good';
            } else if (percentage >= 70) {
                rating = '‚úì Good';
                ratingClass = 'good';
            } else if (percentage >= 60) {
                rating = 'Fair';
                ratingClass = 'fair';
            } else {
                rating = 'Needs Improvement';
                ratingClass = 'poor';
            }
            
            ratingDiv.textContent = rating + ' (' + percentage + '%)';
            ratingDiv.className = `rating ${ratingClass}`;
            
            let summary = `<p>You answered ${score} out of ${total} questions correctly.</p>`;
            if (score === total) {
                summary += '<p style="margin-top: 20px; font-size: 1.2em;">üéâ Perfect Score! Excellent work!</p>';
            }
            
            document.getElementById('resultsSummary').innerHTML = summary;
        }

        async function showStatistics() {
            const modal = document.getElementById('statsModal');
            const content = document.getElementById('statsContent');
            
            // Show modal with loading state
            modal.style.display = 'flex';
            content.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Loading statistics...</div>';
            
            try {
                const response = await fetch('/api/statistics');
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    let html = '<table class="stats-table">';
                    html += '<thead><tr><th>Date</th><th>Score</th><th>Percentage</th></tr></thead>';
                    html += '<tbody>';
                    
                    data.results.forEach(result => {
                        const pct = parseFloat(result.percentage);
                        let pctClass = 'poor';
                        if (pct >= 90) pctClass = 'excellent';
                        else if (pct >= 75) pctClass = 'good';
                        else if (pct >= 60) pctClass = 'fair';
                        
                        html += '<tr>';
                        html += `<td>${result.date}</td>`;
                        html += `<td>${result.score_display}</td>`;
                        html += `<td><span class="stats-percentage ${pctClass}">${result.percentage}</span></td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                    
                    // Add summary stats
                    const scores = data.results.map(r => parseFloat(r.percentage));
                    const avgScore = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1);
                    const bestScore = Math.max(...scores).toFixed(1);
                    
                    html = `
                        <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 150px; background: #f8fafc; padding: 16px; border-radius: 8px; text-align: center;">
                                <div style="color: #64748b; font-size: 0.9em; margin-bottom: 4px;">Total Quizzes</div>
                                <div style="color: #667eea; font-size: 2em; font-weight: bold;">${data.total}</div>
                            </div>
                            <div style="flex: 1; min-width: 150px; background: #f8fafc; padding: 16px; border-radius: 8px; text-align: center;">
                                <div style="color: #64748b; font-size: 0.9em; margin-bottom: 4px;">Average Score</div>
                                <div style="color: #667eea; font-size: 2em; font-weight: bold;">${avgScore}%</div>
                            </div>
                            <div style="flex: 1; min-width: 150px; background: #f8fafc; padding: 16px; border-radius: 8px; text-align: center;">
                                <div style="color: #64748b; font-size: 0.9em; margin-bottom: 4px;">Best Score</div>
                                <div style="color: #48bb78; font-size: 2em; font-weight: bold;">${bestScore}%</div>
                            </div>
                        </div>
                    ` + html;
                    
                    content.innerHTML = html;
                } else {
                    content.innerHTML = `
                        <div class="no-stats">
                            <div class="no-stats-icon">üìä</div>
                            <h3>No statistics yet</h3>
                            <p>Complete a quiz to see your results here!</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
                            // Initialize on page load
                content.innerHTML = `
                    <div class="no-stats">
                        <div class="no-stats-icon">‚ö†Ô∏è</div>
                        <h3>Error loading statistics</h3>
                        <p>Unable to load your quiz history. Please try again.</p>
                    </div>
                `;
            }
        }

        function closeStatistics() {
            document.getElementById('statsModal').style.display = 'none';
        }

        // Initialize on page load
        window.addEventListener('scroll', updateQuickNavVisibility);
        window.addEventListener('load', loadQuestions);
    </script>
</body>
</html>
